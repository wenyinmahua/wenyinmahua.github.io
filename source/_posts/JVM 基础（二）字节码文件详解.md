---
title: JVM 基础（二）字节码文件详解
date: 2024-08-25
updated: 2024-09-03
category: JVM
tags:
  - 笔记
cover: https://tse2-mm.cn.bing.net/th/id/OIP-C.iK1EFamgj6pjOvuhROEFNAHaEK?w=305&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7

---



# JVM 基础（二）字节码文件详解

> 使用 Java 语言编写的 源程序 后缀为 `.java`，结果编译之后会生成 `.class` 后缀的文件，这里就是**字节码**文件了，但是这个字节码文件是通过**二进制**的方式存储，需要通过特殊的工具`jclasslib`转换成易读的形式
>
> 使用 Java 语言编写的代码字节码文件内容具体如下
>
> - **魔数**：（隐含的）每种文件都有的，文件的前四个字节的字符，用来标识文件的类型，如 txt、img、png 等等，这些文件的前四个字节的字符都被被称为**魔数**。其中字节码文件（.class）的魔数是是`0xcafebabe`
> - **Java 版本号：**不同 Java 的某些类的源码可能不同，比如 String 的实现，在 Java 8 及之前底层通过 char 数组来实现，在 Java 9 之后通过 byte 数组来实现，需要通过 Java 的版本号区分。
>   - 从 8 之后，版本号都是 + 44 ，比如字节码文件中主版本号为 52，说明 Java 版本为 52 -44 = 8
> - **访问标志符：**public、static、final、private 等等
> - **常量池：**在 Java 中定义了标识符（类名或接口名、方法名、字段名）和字符串常量，这些数据是在编译之后一般是不变的（即常量）
>   - 常量池的作用：避免相同的内容重复定义，节省空间。
>   - 在 Java 中，常量算是比较常用的内容，重复创建常量对象比较消耗内存，如果能保存起来直接用就好了，那么存这些常量的地方叫做常量池
> - **字段**：类或接口中声明的成员变量
> - **方法：**类或接口中定义的方法信息、字节码指令
> - **属性：**这里的属性指的并不是在类中定义的属性（字段），而是指源码的文件名、内部类的列表



### 1. 字节码文件的组成

![字节码文件的组成](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918212026221.png)

字节码文件中保存了源代码编译后的内容，以二进制的方式存储，推荐通过 IDEA 的插件 `jclasslib` 工具查看字节码文件。

Github地址： https://github.com/ingokegel/jclasslib

字节码文件总共可以分为以下几部分：

- **基础信息：**魔数、字节码文件对应的 Java 版本号、访问标识符、父类和接口等信息。
- **常量池：**保存了字符串常量、类或接口名、字段名，主要在**字节码指令**中使用。
- **字段：**当前类或接口声明的字段信息
- **方法：**当前类或接口声明的方法信息，核心内容为方法的字节码指令
- **属性：**类的属性，比如源码的文件名、内部类列表。

#### 1.1 基本信息

![基本信息](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918205413113.png)

###### Magic 魔数（隐含的，看不到的）

每个 Java 字节码文件的前四个字节是固定的，用 16 进制表示就是 `0xcafebabe`。文件是无法通过文件扩展名来确定文件类型的，文件扩展名可以随意修改不影响文件的内容。软件会使用文件的头几个字节（文件头）去校验文件的类型，如果软件不支持该种类型就会出错。

Java 字节码文件中，将文件头称为 **magic 魔数**。Java 虚拟机会校验字节码文件的前四个字节是不是 0xcafebabe，如果不是，该字节码文件就无法正常使用，Java 虚拟机会抛出对应的错误。



##### 主副版本号

**主副版本号**指的是 编译字节码文件使用的 JDK 版本号，

主版本号 = JDK 版本号 + 44，如主版本号为52，52-44=8，JDK 的版本是8（JDK1.2 之后）

版本号的作用主要是判断当前的字节码的版本和运行时的 JDK 是否兼容。不允许用较低版本的 JDK  去运行较高版本的 JDK 的字节码文件。

出现这种异常，解决方案有两种：

- 升级 JDK 版本（不推荐）
- 降低第三方依赖的版本号或更换依赖（推荐）



##### 其他信息

其他基础信息包括**访问标识**与0**本类、父类**和**接口**的索引（通过这些索引可以找到类、父类、接口的信息。）



#### 1.2 常量池

> 字符串常量、类或接口名、方法名、字段名等等，主要在字节码指令中使用。

![常量池的内容 ](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918205324278.png)

字节码文件中的常量池的作用：避免相同的内容重复定义，节省空间。

> 常量池的数据都有一个编号，类似于 key -value 可以通过编号找到常量池中的数据。

符号引用：字节码指令中通过**编号**引用到**常量池**的过程



#### 1.3 字段

> 类的成员变量

字段中存放的是当前类或接口声明的字段信息。

包含字段的名字、描述符（字段的类型）、访问呢标识符（public/private static final）

![类的字段](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918213154836.png)

#### 1.4 方法

> 类中的方法

字节码的**方法区域**是存放**字节码指令**的核心位置，字节码指令的内容存放在方法的 Code 属性中。需要了解字节码指令的含义。

- init 方法：在对象初始化的时候执行
- main 方法：主方法
- clinit 方法：class init 方法，在类初始化的时候执行，主要是为静态常量（没有被 final 修饰的）赋值
- 自定义的方法

![字节码中的方法](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918212729278.png)

#### 1.5 属性

属性主要是指类的属性、内部类的列表等

- SourceFile
- InnerClasses

![类的属性](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918212537270.png)

![内部类列表](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240918212633446.png)



#### 字节码指令

**操作数栈和局部变量表**是两个主要的内存区域。

**操作数栈**是用来存放临时数据（常量）的内容，是一个栈式的结构，先进后出。

**局部变量表**是存放方法中的局部变量，包含方法的参数、方法中定义的局部变量，在编译期就已经可以确定方法有多少个局部变量。

- 局部变量表都是 从 1 开始的；

> 变量的定义： int i = 5;
>
> - 默认 i 在局部变量表中的索引为 1； 
>
> 1. 常量先入操作数栈 iconst_5
> 2. 弹出操作数栈顶的整数，存储在局部变量表的指定位置；（根据索引存储） istore 1
>

```java
int i = 0;
i = i++;
// 结果是 0
```

字节码：

```
iconst_0 : 将常量 0 放入操作数栈中，下划线后面的数字表示要存入操作数栈的数字
istore1 : 从操作数栈中取出放入局部变量表 1 号位置（弹出操作数栈顶的元素，赋值给局部变量表的 1 号位置的变量）
innc 1 by 1 : 将局部变量表 1 号位置的变量的值 增加 1（这里需要注意的地方是，在局部变量表位置上的值 + 1，而不是操作数栈位置上的数 + 1）
iload 1 : 将局部变量表 1 号位置的数据加载到操作数栈中
istore 1 : 将操作数栈中的值保存到局部变量表 1 号位置
return : 方法结束返回
```



![i= ++i](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240915133129003.png)

i = i++:将 i 的值放入操作数栈中，对局部变量表中的 i 进行自增；将操作数栈栈顶的数字存储到局部变量表中

i = ++ i; 将 局部变量表中 i 进行自增操作，局部变量表 i 的值加载到操作数栈中，

#### 其他字节码指令

| 指令      | 解释                                           |
| --------- | ---------------------------------------------- |
| putstatic | 将操作数栈上的数弹出来，放入堆中静态变狼的位置 |





### 2. 字节码的常用工具



#### 2.1. javap

javap 是 JDK 自带的反编译工具，可以通过控制台查看字节码文件的内容。

输入`javap -v` 字节码文件名称 查看具体的字节码信息，如果 jar 包需要先使用 `jar –xvf` 命令解压。

```shell
javap -v /home/root/User.class > /home/root/User.text
```





#### 2.2. jclasslib 插件

使用 IDEA 安装 jclasslib 插件，可以在代码编译之后实时看到字节码文件内容

选中要查看的源代码文件，选择 `视图(View) - Show Bytecode `

> tips:
>
> 1、一定要选择文件再点击视图(view)菜单，否则菜单项不会出现。
>
> 2、文件修改后一定要重新编译之后，再点击刷新按钮。



#### 2.3 Arthas 

Arthas 是一款线上监控诊断产品，通过全局视角实时查看应用 load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，大大提升线上问题排查效率。 官网：https://arthas.aliyun.com/doc/

下载：[下载 | arthas](https://arthas.aliyun.com/doc/download.html)

**安装方法：**

1、将 arthas-boot.jar 文件复制到任意工作目录。

2、使用`java -jar arthas-boot.jar ` 启动程序。

3、输入需要 Arthas 监控的进程 id。

4、输入命令即可使用。

**dashboard** 

展示当前进程的信息，每个两秒输出，只输出一次

```shell
dashboard -i 2000 -n 1
```



**dump**

命令详解：https://arthas.aliyun.com/doc/dump.html

dump 命令可以将字节码文件保存到本地

```shell
dump -d E:/jvm/data com.mahua.studytest.Main
```



**jad**

命令详解：https://arthas.aliyun.com/doc/jad.html

jad命令可以将类的字节码文件进行反编译成源代码，用于确认服务器上的字节码文件是否是最新的。

```shell
jad com.mahua.studytest.Main
```
