# K8s

## K8s æ¶æ„

K8s æ˜¯ä¸€ä¸ªå…¸å‹çš„ Master-Worker æ¶æ„ï¼ˆç°ç§° Control Plane - Worker Nodeï¼‰ã€‚

- Master-Node(Control Planeï¼ˆæ§åˆ¶å¹³é¢ï¼‰) è´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤
  - ä½¿é›†ç¾¤èƒ½ç®¡ç†ä¸åŒçš„ Node
  - è°ƒåº¦ä¸åŒçš„ Pod åˆ°åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼ˆæ¯”å¦‚æœ‰å……è¶³çš„å†…å­˜èµ„æºï¼‰
  - ç›‘æ§èŠ‚ç‚¹ä¸ Pod çš„çŠ¶æ€
  - æ·»åŠ æˆ–è€…åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹

æ ¸å¿ƒç»„ä»¶ï¼š
| ç»„ä»¶ | ä½œç”¨ |
| --- | --- |
| kube-apiserver | é›†ç¾¤ç»Ÿä¸€å…¥å£ï¼Œæä¾› REST APIï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚ï¼ˆè®¤è¯ã€æˆæƒã€éªŒè¯ï¼‰ |
| etcd | é«˜å¯ç”¨é”®å€¼å­˜å‚¨ï¼Œä¿å­˜é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çŠ¶æ€ï¼ˆå¦‚ Podã€Serviceã€Deploymentï¼‰ |
| kube-scheduler | ç›‘æ§æœªè°ƒåº¦çš„ Podï¼Œæ ¹æ®èµ„æºã€äº²å’Œæ€§ç­‰ç­–ç•¥å°†å…¶åˆ†é…åˆ°åˆé€‚çš„ Node |
| kube-controller-manager | è¿è¡Œæ§åˆ¶å™¨å¾ªç¯ï¼Œç¡®ä¿é›†ç¾¤çŠ¶æ€ä¸æœŸæœ›ä¸€è‡´ï¼ˆå¦‚æ•…éšœæ—¶é‡å»º Podï¼‰ |
| cloud-controller-manager(CCM) | ï¼ˆäº‘ç¯å¢ƒï¼‰å¯¹æ¥äº‘å¹³å° APIï¼Œç®¡ç† LoadBalancerã€Node æ ‡ç­¾ã€äº‘ç£ç›˜ç­‰ |

ç”Ÿäº§å»ºè®®ï¼šControl Plane é€šå¸¸éƒ¨ç½²ä¸º 3 æˆ– 5 èŠ‚ç‚¹é«˜å¯ç”¨é›†ç¾¤ï¼Œå‰ç«¯åŠ è´Ÿè½½å‡è¡¡å™¨ã€‚
- Worker-Node è´Ÿè´£è¿è¡Œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡

æ ¸å¿ƒç»„ä»¶ï¼š
| ç»„ä»¶ | ä½œç”¨ |
| --- | --- |
| kubelet | ä¸ API Server é€šä¿¡ï¼Œç¡®ä¿æœ¬æœº Pod æŒ‰ Spec è¿è¡Œï¼›ä¸ŠæŠ¥èŠ‚ç‚¹çŠ¶æ€ |
| kube-proxy | å®ç° Service çš„é›†ç¾¤å†…éƒ¨è´Ÿè½½å‡è¡¡ï¼ˆé€šè¿‡ iptables/IPVSï¼‰ |
| Container Runtime	| è¿è¡Œå®¹å™¨çš„åº•å±‚å¼•æ“ï¼ˆå¦‚ containerdã€CRI-Oã€Docker Engineï¼‰ |

## K8s æ ¸å¿ƒæ¦‚å¿µ

- Node:èŠ‚ç‚¹ï¼šä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå¯ä»¥è¿è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ª Podï¼ˆç´§å¯†è€¦åˆï¼‰
  - ä¸ºäº†èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ¯ä¸ª Node ä¸Šéƒ½ä¼šåŒ…å«ä¸‰ä¸ªç»„ä»¶ kubeletã€kube-proxy åŠ èª container-runtimeï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¿è¡Œå®¹å™¨çš„è½¯ä»¶ï¼Œè´Ÿè´£æ‹‰å–å®¹å™¨é•œåƒã€åˆ›å»ºå®¹å™¨ã€å¯åŠ¨æˆ–åœæ­¢å®¹å™¨ç­‰ç­‰ï¼Œæ‰€æœ‰çš„å®¹å™¨éƒ½éœ€è¦ container-runtime æ¥è¿è¡Œï¼‰
    - kubeletï¼š
      - è´Ÿè´£ç®¡ç†å’Œç»´æŠ¤æ¯ä¸ª Node çš„ Podï¼Œå¹¶ç¡®ä¿ Pod èƒ½æŒ‰ç…§é¢„æœŸè¿è¡Œï¼Œ
      - å®šæœŸä» api-server ç»„ä»¶ç»„ä»¶æ¥æ”¶æ–°çš„æˆ–è€…ä¿®æ”¹åçš„ Pod è§„èŒƒï¼Œ
      - ç›‘æ§å·¥ä½œèŠ‚ç‚¹çš„è¿è¡Œæƒ…å†µï¼Œå°†è¿™äº›ä¿¡æ¯æ±‡æŠ¥ç»™ api-server
    - kube-proxyï¼š
      - è´Ÿè´£ä¸º Pod å¯¹è±¡æä¾›ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡æœåŠ¡
      - åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Node é€šå¸¸è¿è¡Œå¤šä¸ª Podã€‚å½“ä¸€ä¸ª Pod éœ€è¦è®¿é—®å¦ä¸€ç»„ Pod æä¾›çš„æœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ **Service çš„è™šæ‹Ÿ IPï¼ˆClusterIPï¼‰æˆ– DNS åç§°**å‘èµ·è¯·æ±‚ã€‚
      - Kubernetes é€šè¿‡ **kube-proxy** ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå®ç°**åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡**ï¼škube-proxy ç›‘å¬ Service å’Œåç«¯ Pod çš„å˜åŒ–ï¼Œå¹¶åŠ¨æ€ç»´æŠ¤æœ¬æœºçš„ **iptables æˆ– IPVS è§„åˆ™**ï¼Œå°†å‘å¾€ Service çš„æµé‡**é€æ˜åœ°è½¬å‘åˆ°å¥åº·çš„åç«¯ Pod**ï¼ˆå¯èƒ½ä½äºä»»æ„èŠ‚ç‚¹ï¼‰ï¼Œä»è€Œå®ç°æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ã€‚
      - âŒKube-proxy ä½¿æœ‰è€¦åˆçš„ Podï¼ˆåº”ç”¨ç¨‹åºä¸æ•°æ®åº“ï¼‰ è®¿é—®ä¸ä¼šè¢«éšæœºè·¯ç”±åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯ä¼šè¢«è·¯ç”±åˆ°å’Œåº”ç”¨ç¨‹åºåŒä¸€ä¸ª Node çš„ æ•°æ®åº“ Podï¼ŒèŠ‚çœäº†æŠŠè¯·æ±‚è½¬å‘åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œå¼€é”€ã€‚
      - **kube-proxyï¼ˆiptables æ¨¡å¼ï¼‰é»˜è®¤ä½¿ç”¨éšæœºï¼ˆæˆ–è½®è¯¢ï¼‰è´Ÿè½½å‡è¡¡**ï¼Œ**å®Œå…¨ä¸è€ƒè™‘ Pod æ˜¯å¦ä¸å®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š**ã€‚
    - å¸¸è§çš„container-runtimeï¼š
      - Docker-Engine
      - Containerd
      - CRI-O
      - Mirantis Container Runtime

- Pod æ˜¯ Kubernetes çš„æœ€å°è°ƒåº¦å•å…ƒï¼Œåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨çš„è¿è¡Œç¯å¢ƒï¼Œä¸€ä¸ª Pod æœ€å¥½åªè¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œå¤šä¸ªå®¹å™¨éœ€è¦è¿™äº›å®¹å™¨é«˜åº¦è€¦åˆ

  - åœ¨è¿™ä¸ªç¯å¢ƒä¸­ï¼Œå®¹å™¨å¯ä»¥å…±äº«èµ„æºï¼Œæ¯”å¦‚ç½‘ç»œã€å­˜å‚¨ä»¥åŠä¸€äº›è¿è¡Œæ—¶çš„é…ç½®ç­‰ç­‰
  - å¤šä¸ªå®¹å™¨æ”¾åœ¨ä¸€èµ·æ˜¯å› ä¸ºè¦å®ç°æŸä¸ªåŠŸèƒ½ æˆ–è€… å…±äº«æŸäº›èµ„æºï¼Œä¸å¾—ä¸æ”¾åœ¨ä¸€èµ·ï¼Œæ¯”å¦‚ Sidecar  è¾¹è½¦æ¨¡å¼ï¼Œå°†ä¸€ä¸ªåº”ç”¨å®¹å™¨å’Œä¸€ä¸ªè¾…åŠ©å®¹å™¨æ”¾åœ¨ä¸€ä¸ª Pod ä¸­ï¼Œè¿™ä¸ªè¾…åŠ©å®¹å™¨å°±æ˜¯ Sidecarï¼Œé€šå¸¸ç”¨æ¥å®ç°ä¸€äº›è¾…åŠ©çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ—¥å¿—æ”¶é›†ã€ç›‘æ§æˆ–è€…é…ç½®ç®¡ç†ç­‰ç­‰

  - Pod çš„ IP åœ°å€å›åœ¨ Pod åˆ›å»ºçš„æ—¶å€™è‡ªåŠ¨åˆ†é…ï¼Œæ˜¯ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„ IP åœ°å€ï¼ŒPod ä¹‹é—´å¯ä»¥é€šè¿‡è¿™ä¸ª IP åœ°å€æ¥è¿›è¡Œé€šä¿¡

    ![Pod çš„è¯¦æƒ…](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20251127220619251.png)

  - Pod çš„ IP åœ°å€æ˜¯ä¸€ä¸ªå†…éƒ¨åœ°å€ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨æ˜¯æ— æ³•è®¿é—®çš„

  - Pod æ˜¯ä¸€ä¸ªä¸ç¨³å®šçš„å®ä½“ï¼Œéå¸¸å®¹æ˜“è¢«é”€æ¯æˆ–è€…åˆ›å»ºï¼Œå‘ç”Ÿæ•…éšœæ—¶ï¼ŒKubernetes ä¼šå°†è¿™ä¸ªå‘ç”Ÿæ•…éšœçš„ Pod é”€æ¯ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ¥ä»£æ›¿å®ƒï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒPod çš„ IP å°±å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKubernetes æä¾›äº†ä¸€ä¸ªå« **Service(SVC)** çš„èµ„æºå¯¹è±¡ï¼›

  - å½“ Pod è¢«é”€æ¯æˆ–è€…é‡å¯çš„æ—¶å€™ï¼Œå®¹å™¨çš„æ•°æ®ä¹Ÿä¼šè·Ÿç€æ¶ˆå¤±ï¼ŒKubernetes æä¾›äº†ä¸€ä¸ªå« **Volumes** çš„ç»„ä»¶ï¼Œå¯ä»¥å°†ä¸€äº›æŒä¹…åŒ–çš„èµ„æºæŒ‚è½½åˆ°é›†ç¾¤ä¸­çš„æœ¬åœ°ç£ç›˜ä¸Šï¼Œæˆ–è€…æŒ‚è½½åˆ°é›†ç¾¤å¤–éƒ¨çš„è¿œç¨‹å­˜å‚¨ä¸Š

- Service å¯ä»¥å°†ä¸€ç»„ Pod å°è£…æˆä¸€ä¸ªæœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„å…¥å£æ¥è®¿é—®ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ Service çš„ IP åœ°å€æ¥è®¿é—®å¦å¤–çš„ Podï¼ŒService ä¼šå°†è¯·æ±‚è½¬å‘ç»™å…¶ä»–çš„å¥åº·çš„ Pod ä¸Šï¼Œå°±å¯ä»¥è§£å†³ Pod çš„ IP åœ°å€ä¸ç¨³å®šçš„é—®é¢˜

  ![Service çš„ä½œç”¨](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20251127221539942.png)

- Ingressï¼šIngress æ˜¯ç”¨æ¥ç®¡ç†ä»é›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡çš„å…¥å£å’Œæ–¹å¼çš„ï¼Œ

  - å¯ä»¥é€šè¿‡ Ingress æ¥é…ç½®ä¸åŒçš„è½¬å‘è§„åˆ™ï¼Œä»è€Œæ ¹æ®ä¸åŒçš„è§„åˆ™æ¥è®¿é—®é›†ç¾¤å†…éƒ¨ä¸åŒçš„ Serviceï¼Œä»¥åŠ Service æ‰€å¯¹åº”çš„åç«¯ Pod
  - è¿˜å¯ä»¥é€šè¿‡ Ingress æ¥é…ç½®åŸŸåï¼Œè¿™æ ·å°±å¯ä»¥å°†åŸæ¥ä½¿ç”¨ IP åœ°å€å’Œ ç«¯å£å·çš„æ–¹å¼è½¬æ¢æˆä½¿ç”¨åŸŸåçš„æ–¹å¼è®¿é—® Service
  - Ingress è¿˜å¯ä»¥é…ç½®ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ è´Ÿè½½å‡è¡¡ã€SSL è¯ä¹¦ç­‰ç­‰

- ConfigMapï¼šå°†ä¸€äº›é…ç½®ä¿¡æ¯å°è£…èµ·æ¥ï¼Œå°±å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­è¯»å–å’Œä½¿ç”¨

  - ConfigMap å¯ä»¥å°† é…ç½®ä¿¡æ¯å’Œåº”ç”¨ç¨‹åºçš„é•œåƒå†…å®¹åˆ†ç¦»å¼€æ¥ï¼Œä¿æŒå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼Œå½“æŸä¸ªä¸­é—´ä»¶çš„ IP åœ°å€å’Œç«¯å£å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥åªä¿®æ”¹ ConfigMap å¯¹è±¡ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œé‡æ–°åŠ è½½ Pod å°± OK äº†ï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å’Œéƒ¨ç½²åº”ç”¨ç¨‹åºäº†ï¼Œå®ç°åº”ç”¨ç¨‹åºå’Œä¸­é—´ä»¶çš„è§£è€¦
  - ConfigMap ä¸­çš„é…ç½®ä¿¡æ¯éƒ½æ˜¯æ˜æ–‡çš„ï¼Œä¸€äº›è´¦å·å¯†ç ä¸èƒ½è¿™æ ·æ”¾ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Kubernetes æä¾›äº†ä¸€ä¸ªå« Secret çš„ç»„ä»¶

- Secretï¼šå°†æ•æ„Ÿä¿¡æ¯å°è£…èµ·æ¥ï¼Œè®©åº”ç”¨ç¨‹åºå»è¯»å–å’Œä½¿ç”¨ï¼Œåªæ˜¯åšäº†ä¸€å±‚ Base64 çš„ç¼–ç ï¼Œåªä¾é  Secret ä¸èƒ½ä¿è¯æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨ï¼Œéœ€è¦ä¾é ä¸€äº›Kubernetes æä¾›çš„ä¸€äº›å…¶ä»–çš„å®‰å…¨æœºåˆ¶ï¼Œå¦‚ç½‘ç»œå®‰å…¨ã€è®¿é—®æ§åˆ¶ã€èº«ä»½è®¤è¯ç­‰ç­‰

- Deploymentï¼šå¯ä»¥å®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å‰¯æœ¬æ•°é‡ä»¥åŠåº”ç”¨ç¨‹åºçš„æ›´æ–°ç­–ç•¥ï¼Œå¯ä»¥ç®€åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²å’Œæ›´æ–°æ“ä½œï¼Œå…·æœ‰å‰¯æœ¬æ§åˆ¶ã€æ»šåŠ¨æ›´æ–°ã€è‡ªåŠ¨æ‰©ç¼©å®¹ç­‰é«˜çº§ç‰¹æ€§å’ŒåŠŸèƒ½

  - å‰¯æœ¬æ§åˆ¶ï¼šå¯ä»¥å®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„å‰¯æœ¬æ•°é‡ï¼›
  - æ»šåŠ¨æ›´æ–°ï¼šå¯ä»¥å®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„æ›´æ–°ç­–ç•¥ï¼Œå¯ä»¥è½»æ¾åœ°å‡çº§åº”ç”¨ç¨‹åºåœ°ç‰ˆæœ¬ï¼Œé€æ¸ç”¨æ–°çš„ç‰ˆæœ¬æ›¿æ¢æ‰æ—§çš„ç‰ˆæœ¬ï¼Œä¿è¯åº”ç”¨ç¨‹åºçš„å¹³æ»‘å‡çº§

  ![Deployment](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20251127224308579.png)

- StatefulSetï¼šç®¡ç†æœ‰çŠ¶æ€å®¹å™¨çš„ Podï¼ˆè¿è¡Œç€åƒæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ä¹‹ç±»æœ‰çŠ¶æ€çš„åº”ç”¨å’Œä¸€äº›ä¿ç•™ä¼šè¯çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œä¸ Deployment éå¸¸ç±»ä¼¼ï¼Œä¹Ÿæä¾›äº†å®šä¹‰å’Œç®¡ç†åº”ç”¨ç¨‹åºå‰¯æœ¬æ•°é‡å’ŒåŠ¨æ€æ‰©ç¼©å®¹ç­‰ç­‰çš„åŠŸèƒ½ï¼Œèƒ½ä¿è¯æ¯ä¸ªå‰¯æœ¬éƒ½æœ‰è‡ªå·±ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ç¬¦å’ŒæŒä¹…åŒ–å­˜å‚¨
  - ä¸æ˜¯æ‰€æœ‰çš„æœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºéƒ½é€‚åˆä½¿ç”¨ StatefulSet æ¥éƒ¨ç½²çš„ï¼Œé€šå¸¸ä¸ä¾é  k8sï¼Œç‹¬ç«‹éƒ¨ç½²çš„



---

ingress è´Ÿè´£å¤„ç† http æµé‡ï¼Œkube-proxy è´Ÿè´£å¤„ç† Node å†…éƒ¨çš„ Service-Podã€Pod-Pod ä¹‹é—´çš„ TCP/UDP æµé‡

---

ReplicaSet æ˜¯ç”¨æ¥ç®¡ç† Pod çš„å‰¯æœ¬æ•°é‡çš„

Deployment ç®¡ç† ReplicaSetã€ReplicaSet ç®¡ç†çš„æ˜¯ Pod

### Master-Node çš„å››ä¸ªç»„ä»¶

kube-apiserverã€etcdã€ControllerManager å’Œ Scheduler

kube-apiserverï¼šè´Ÿè´£æä¾› Kubernetes é›†ç¾¤çš„ API æ¥å£æœåŠ¡ï¼Œæ‰€æœ‰çš„ç»„ä»¶éƒ½ä¼šé€šè¿‡è¿™ä¸ªæ¥å£æ¥é€šä¿¡

- å½“ç”¨æˆ·éœ€è¦åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ä¸€äº›å®¢æˆ·ç«¯æ¥ä¸ apiserver è¿›è¡Œäº¤äº’ï¼Œæ¯”å¦‚ kubectl å‘½ä»¤è¡Œå·¥å…·ã€Dashboard æˆ–è€…å…¶ä»–çš„ä¸€äº›å›¾å½¢åŒ– UI å·¥å…·ã€‚
- apiserver æ˜¯æ•´ä¸ªé›†ç¾¤çš„å…¥å£ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šå…ˆç»è¿‡å®ƒï¼Œç„¶åå†ç”±å®ƒæ¥åˆ†å‘ç»™ä¸åŒçš„ç»„ä»¶è¿›è¡Œå¤„ç†
  - æ¯”å¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ Pod çš„è¯·æ±‚æˆ–è€…æ˜¯ä¸€äº›æŸ¥è¯¢é›†ç¾¤çŠ¶æ€çš„å‘½ä»¤éƒ½ä¼šå…ˆç»è¿‡ apiserverï¼Œå†è½¬å‘ç»™ç›¸åº”çš„ç»„ä»¶æ¥å¤„ç†
- apiservere è´Ÿè´£å¯¹æ‰€æœ‰èµ„æºå¯¹è±¡çš„ crud ç­‰æ“ä½œè¿›è¡Œè®¤è¯ã€æˆæƒå’Œè®¿é—®æ§åˆ¶ï¼Œç¡®ä¿åªæœ‰ç»è¿‡è®¤è¯å’Œæˆæƒçš„ç”¨æˆ·æ‰èƒ½å¤Ÿè®¿é—®åˆ°é›†ç¾¤ä¸­çš„èµ„æºå¯¹è±¡ï¼Œä»è€Œæé«˜äº†æ•´ä¸ªé›†ç¾¤ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚

Schedulerï¼šè´Ÿè´£ç›‘æ§é›†ç¾¤ä¸­çš„æ‰€æœ‰çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œæ ¹æ®ä¸€äº›è°ƒåº¦ç­–ç•¥ï¼Œå°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node ä¸Šè¿è¡Œï¼ˆæ¯”å¦‚è¯¥ Node çš„èµ„æºå……è¶³ï¼‰

ControllerManagerï¼šè´Ÿè´£ç®¡ç†é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„çŠ¶æ€

- å½“é›†ç¾¤çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹çš„ Pod å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œç›‘æ§å’Œæ£€æµ‹åˆ°è¿™ä¸ªæ•…éšœï¼Œç„¶åå°½å¯èƒ½åœ°å¯¹è¿™ä¸ªæ•…éšœè¿›è¡Œå¤„ç†ï¼ˆé‡å¯ Pod æˆ–è€…ä½¿ç”¨å…¶ä»–çš„ Pod æ¥ä»£æ›¿å®ƒï¼‰

etcdï¼šæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„é”®-å€¼å­˜å‚¨ç³»ç»Ÿï¼Œç”¨æ¥å­˜å‚¨é›†ç¾¤ä¸­æ‰€æœ‰èµ„æºå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯

- å½“ä¸€ä¸ª Pod æŒ‚æ‰å´©æºƒäº†æˆ–è€…å¢åŠ äº†ä¸€ä¸ªæ–°çš„ Pod ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯éƒ½ä¼šè®°å½•åœ¨ etcd é‡Œé¢ï¼Œæ˜¯æ•´ä¸ªé›†ç¾¤çš„å¯¹æ‰€æœ‰çš„èµ„æºå¯¹è±¡çš„çŠ¶æ€æ•°æ®å­˜å‚¨ä¸­å¿ƒ
- å½“æŸ¥è¯¢æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€æ—¶ï¼Œä¿¡æ¯å°±æ˜¯ä» etcd é‡Œé¢è·å–çš„



å¦‚æœä½¿ç”¨äº‘æœåŠ¡å•†å¦‚ Googleã€AWS æä¾›çš„ Kubenetes é›†ç¾¤ï¼Œè¿˜ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ç»„ä»¶-- Cloud-Controller-Managerï¼ˆäº‘æ§åˆ¶ç®¡ç†å™¨ï¼‰

- æ˜¯ä¸€ä¸ªäº‘å¹³å°ç›¸å…³çš„æ§åˆ¶å™¨ï¼Œè´Ÿè´£ä¸äº‘å¹³å°çš„ API è¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”æä¾›äº†ä¸€è‡´çš„ç®¡ç†æ¥å£ï¼Œä½¿ç”¨æˆ·æ›´èƒ½æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„äº‘å¹³å°è¿è¡Œå’Œç®¡ç†ä»–ä»¬çš„åº”ç”¨ç¨‹åº



## å¤–éƒ¨æœåŠ¡çš„å¸¸ç”¨ç±»å‹

NodePort:å›åœ¨ Node ä¸Šå¼€å‘ä¸€ä¸ªç«¯å£ï¼Œç„¶åå°†è¿™ä¸ªç«¯å£æ˜ å°„åˆ° service çš„ IP åœ°å€å’Œç«¯å£ä¸Šï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ Node çš„ IP åœ°å€å’Œ Post æ¥è®¿é—® service äº†

ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸æ˜¯é€šè¿‡åŸŸåæ¥è®¿é—®æœåŠ¡çš„

![NodePort](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20251128014304768.png)

- ClusterIPï¼šé»˜è®¤ç±»å‹ï¼Œé›†ç¾¤å†…éƒ¨æœåŠ¡
- NodePortï¼šèŠ‚ç‚¹ç«¯å£ç±»å‹ï¼Œå°†æœåŠ¡å…¬å¼€åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Š
- LoadBalancerï¼šè´Ÿè½½å‡è¡¡ç±»å‹ï¼Œå°†æœåŠ¡å…¬å¼€åˆ°å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä¸Š
- ExternalNameï¼šå¤–éƒ¨åç§°ç±»å‹ï¼Œé€šè¿‡è¿”å›ä¸€ä¸ª CNAME è®°å½•ï¼Œå°†æœåŠ¡æ˜ å°„åˆ°ä¸€ä¸ªå¤–éƒ¨åŸŸåä¸Š
- Headlessï¼šæ— å¤´ç±»å‹ï¼Œåˆ›å»ºä¸€ä¸ªæ²¡æœ‰ ClusterIP çš„æœåŠ¡ï¼Œç”¨äº DNS è§£æå’ŒæœåŠ¡å‘ç°

## minikube æ­å»ºç¯å¢ƒ

### minikube å’Œ kebuctl

minikube æ˜¯ä¸€ä¸ªè½»é‡çº§ Kubenetes å‘è¡Œç‰ˆï¼Œå¯ä»¥åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šè¿è¡Œä¸€ä¸ªå•èŠ‚ç‚¹çš„ kubernetes é›†ç¾¤

> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ Kubernetes é›†ç¾¤ä¸€èˆ¬éƒ½æ˜¯ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€å°æœåŠ¡å™¨æˆ–è€…è™šæ‹Ÿæœº



kubectl å‘½ä»¤è¡Œå·¥å…·ç”¨æ¥å’Œ Kubernetes è¿›è¡Œäº¤äº’ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ª Pod å’Œ Serviceï¼ŒæŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€ç­‰ç­‰

- å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œè¾“å…¥å„ç§å‘½ä»¤çš„æ–¹å¼ï¼Œæ¥ä¸ kubernetes é›†ç¾¤è¿›è¡Œäº¤äº’ï¼Œç®¡ç†é›†ç¾¤çš„èµ„æº



## K8s å¸¸ç”¨çš„æŒ‡ä»¤

- kubectl get nodes/svc/pod/deployment/replicaset/allï¼šæŸ¥çœ‹é›†ç¾¤ä¸­çš„èŠ‚ç‚¹/service/pod çŠ¶æ€
- kubectl run nginx --image=nginxï¼šåˆ›å»ºä¸€ä¸ª nginx pod
- kubectl create -h å¸®åŠ©
  - kubectl create nginx-deployment --image=nginx
- kubectl edit deployment nginx-deployment
- kubectl delete deployment nginx-deployment
- kubectl create deployment nginx-dep --image-nginx --replicas-3
- kubectl get pod -o wide  # å¯ä»¥çœ‹åˆ° pod æ‰€åœ¨çš„èŠ‚ç‚¹å’Œ Pod çš„ IP åœ°å€
- kubectl create service nginx-serviceï¼ˆä¸æ¨èï¼‰
- kubectl expose deployment deployment nginx-deployment
- kubectl describe service nginx-deployment
- kubectl delete service nginx-deployment
# æŸ¥çœ‹ Service å¯¹åº”çš„ Endpoints
- kubectl get endpoints nginx-svc

- kubectl get nodes/pods/svc/deployments/all
- kubectl get pod -o wide          # æ˜¾ç¤º Node å’Œ Pod IP
- kubectl describe pod <pod-name>  # æŸ¥çœ‹äº‹ä»¶ï¼ˆæ’æŸ¥è°ƒåº¦å¤±è´¥ï¼‰
- kubectl top nodes/pods           # æŸ¥çœ‹èµ„æºä½¿ç”¨

### k8s è°ƒè¯•å‘½ä»¤

- kubectl logs ${podname}
- kubectl exec -it ${podname} -- /bin/bash   ä½¿ç”¨äº¤äº’å¼ç»ˆç«¯



## yml é…ç½®æ–‡ä»¶çš„ä½¿ç”¨

```yaml
apiVersion: apps/v1          # å®šä¹‰è¿™ä¸ªæ–‡ä»¶ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ api åŒ apiserver è¿›è¡Œäº¤äº’ï¼ŒAPI çš„ç»„åˆ«/ç‰ˆæœ¬ï¼šgroup/version
kind: Deployment             # æŒ‡å®šèµ„æºå¯¹è±¡çš„ç±»å‹ï¼Œ Deploymentã€Serviceã€ConfigMap ç­‰ç­‰
metedata:				     # å®šä¹‰èµ„æºçš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚èµ„æºå¯¹è±¡çš„åç§°ã€æ ‡ç­¾ã€å‘½åç©ºé—´ç­‰
  name: nginx-deployment
spec:                        # specificationï¼šè§„èŒƒï¼Œå®šä¹‰å„ç§èµ„æºå¯¹è±¡çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤šå°‘ä¸ªå‰¯æœ¬ï¼Œä½¿ç”¨å“ªä¸ªé•œåƒã€æš´éœ²å“ªä¸ªç«¯å£ç­‰ç­‰
  selector:                # ç”¨æ¥é€‰æ‹©ç‰¹å®šçš„èµ„æºï¼Œä¸€èˆ¬å’Œ label æ ‡ç­¾ä¸€èµ·ä½¿ç”¨
    matchLabels:
        app: nginx
  replicas: 3
  template:
    metadata:
      labels:
          app: nginx
    spec:               # åµŒå¥—çš„ specï¼Œè¿™ä¸ª spec æ˜¯å®šä¹‰ Pod çš„é…ç½®ä¿¡æ¯
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
          - containerPort:80
```

nginx-deployment.yaml

API ç»„åˆ«ï¼š

- appsï¼šåº”ç”¨
- batchï¼šæ‰¹å¤„ç†
- autoscalingï¼šè‡ªåŠ¨æ‰©ç¼©å®¹

versionï¼š

- v1
- v1beta1ï¼ˆæ¯ä¸ªç‰ˆæœ¬çš„é…ç½®é¡¹åœ¨å¦å¤–ä¸€ä¸ªç‰ˆæœ¬ä¸­å¯èƒ½ä¸å­˜åœ¨äº†ï¼‰

ğŸ“Œ API ç‰ˆæœ¬è¯´æ˜ï¼š
- apps/v1ï¼šDeploymentã€StatefulSet
- v1ï¼šPodã€Serviceã€ConfigMap
- batch/v1ï¼šJobã€CronJob
- networking.k8s.io/v1ï¼šIngress


å®šä¹‰å¥½ nginx-deployment.yaml æ–‡ä»¶ï¼Œä½¿ç”¨

- kubectl create -f nginx-deployment.yaml æ¥åˆ›å»ºèµ„æºå¯¹è±¡
- kubectl delete -f nginx-deployment.yaml æ¥åˆ é™¤èµ„æºå¯¹è±¡
- kubectl apply -f nginx-deployment.yaml æ¥åˆ›å»ºæˆ–è€…æ›´æ–°èµ„æºå¯¹è±¡



```yml
apiVersion: v1
kind: service
metadata:
  name: nginx-service
spec:
  type: NodePort      # ä¸æŒ‡å®šçš„è¯ï¼Œé»˜è®¤æ˜¯ ClusterIP ç±»å‹çš„æœåŠ¡ï¼ˆé›†ç¾¤å†…éƒ¨æœåŠ¡ï¼‰
  selector:
      app: nginx
  ports:
    - protocol: TCP
      pod: 80          # service å¯¹å¤–å¼€æ”¾çš„ç«¯å£
      targetPort: 80   # Pod ç«¯å£
      nodePort: 30080     # èŠ‚ç‚¹å¯¹å¤–æä¾›ç»™æœåŠ¡çš„ç«¯ï¼Œè¿™é‡Œçš„èŠ‚ç‚¹ç«¯å£èŒƒå›´å¿…é¡»åœ¨ 30000-32767 ä¹‹é—´
```



-----------------------

å‘½åç©ºé—´æ˜¯ç”¨æ¥å¯¹é›†ç¾¤ä¸­çš„èµ„æºè¿›è¡Œéš”ç¦»å’Œæˆ¿ç§Ÿçš„ä¸€ç§æœºåˆ¶

æ²¡æœ‰æŒ‡å®šå‘½åç©ºé—´ namespaceï¼Œä¼šä½¿ç”¨ default è¿™ä¸ªå‘½åç©ºé—´ï¼Œä¸€èˆ¬ç”¨æ¥éš”ç¦»ä¸åŒçš„é¡¹ç›®æˆ–è€…ä¸åŒçš„ç¯å¢ƒ

- kebuctl get namespaces /ns

- kubectl get namespaces
- kubectl create namespace my-app































































