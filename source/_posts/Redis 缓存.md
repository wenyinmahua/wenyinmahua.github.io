---
title: Redis ç¼“å­˜
date: 2024-01-20
updated: 2024-01-20
tags: 
  - å®æˆ˜
  - é¢è¯•
category: Redis
comments: true
top_single_background: https://tse2-mm.cn.bing.net/th/id/OIP-C.og0rQ01xv6I7e1LpSbNIVQAAAA?w=311&h=106&c=7&r=0&o=5&dpr=1.3&pid=1.7
cover: https://tse4-mm.cn.bing.net/th/id/OIP-C.Jed-UVwaIqf16oq5f8ATDQHaE8?w=251&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7
---
# Redis ç¼“å­˜
> æ€»ç»“:
> - ç¼“å­˜ç©¿é€æ˜¯å› ä¸ºæ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®;
> - ç¼“å­˜é›ªå´©æ˜¯å› ä¸ºå¤§é‡çš„ key åœ¨ä¸€ä¸ªæ—¶é—´æ®µå¤±æ•ˆ;
> - ç¼“å­˜å‡»ç©¿æ˜¯ ä¸€ä¸ªçƒ­ç‚¹ key å¤±æ•ˆäº†,å¯¼è‡´æ•°æ®åº“å—åˆ°äº†ä¼¤å®³,æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ª Key å¤±æ•ˆäº†

**ç¼“å­˜ï¼š**æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆCacheï¼‰ï¼Œæ˜¯å­˜è´®æ•°æ®çš„ä¸´æ—¶åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç¼“å­˜åŒºçš„æ•°æ®ï¼Œä¸€èˆ¬è¯»å†™æ€§èƒ½è¾ƒé«˜ã€‚

**ä¼˜ç‚¹ï¼š**

- é™ä½åç«¯è´Ÿè½½
- æé«˜è¯»å†™æ•ˆç‡ï¼Œé™ä½å“åº”æ—¶é—´

**ç¼ºç‚¹ï¼š**

- ç¼“å­˜çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼›ï¼ˆæ•°æ®åº“ä¸­çš„æ•°æ®æ”¹äº†ï¼Œå¯èƒ½ç¼“å­˜è¿˜æ²¡æ”¹ï¼‰



>å°†æ•°æ®åº“ä¸­çš„å¸¸ç”¨çš„æ•°æ®æŸ¥è¯¢å‡ºæ¥ä¹‹åä¿å­˜åœ¨ Redis ä¸­ï¼Œæ¯ä¸€æ¬¡æŸ¥è¯¢åå°æ•°æ®æ—¶ï¼Œéƒ½å…ˆåœ¨ Redis ä¸­æŸ¥è¯¢æ˜¯å¦æœ‰ç¼“å­˜ï¼Œ
>
>- æœ‰ç¼“å­˜ï¼Œä½¿ç”¨ JSONUtils å·¥å…·å°†**ä»ç¼“å­˜ä¸­å–å‡ºçš„æ•°æ®**è½¬æ¢ä¸ºç›¸åº”çš„æ•°æ®ç±»å‹è¿”å›ï¼›
>- æ— ç¼“å­˜ï¼Œä»æ•°æ®åº“ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®ï¼Œå°†æŸ¥è¯¢çš„æ•°æ®é€šè¿‡ JSONUtils å·¥å…·è½¬æ¢ä¸º JSON æ ¼å¼çš„æ•°æ®è¿”å›ã€‚



### ç¼“å­˜æ›´æ–°ç­–ç•¥

- å†…å­˜æ·˜æ±°ï¼ˆmax-memeryï¼‰
- è¶…æ—¶å‰”é™¤ï¼ˆttlï¼‰
- ä¸»åŠ¨æ›´æ–°ï¼ˆæ‰‹åŠ¨ï¼‰

|          | å†…å­˜æ·˜æ±°                                                     | è¶…æ—¶å‰”é™¤                                                    | ä¸»åŠ¨æ›´æ–°                                     |
| :------: | ------------------------------------------------------------ | :---------------------------------------------------------- | :------------------------------------------- |
|   è¯´æ˜   | ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨ Redis çš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚ | ç»™ç¼“å­˜æ•°æ®å¢åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚ | ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚ |
|  ä¸€è‡´æ€§  | å·®                                                           | ä¸€èˆ¬                                                        | å¥½                                           |
| ç»´æŠ¤æˆæœ¬ | æ—                                                            | ä½                                                          | é«˜                                           |

**ä¸šåŠ¡åœºæ™¯ï¼š**

- ä½ä¸€è‡´æ€§ï¼šä½¿ç”¨ Redis è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚ä¸å¸¸å˜çš„æŸ¥è¯¢ç¼“å­˜ã€‚
- é«˜ä¸€è‡´æ€§ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚å¸¸å˜çš„æ•°æ®çš„ç¼“å­˜ã€‚



#### æ•°æ®åº“å’Œç¼“å­˜å¯èƒ½å­˜åœ¨ä¸ä¸€è‡´æ€§

ç¼“å­˜æ¥æºäºæ•°æ®åº“ï¼Œæ•°æ®åº“é‡Œé¢çš„æ•°æ®æ˜¯å‘ç”Ÿå˜åŒ–çš„ï¼Œä¾æ¬¡ï¼Œå¦‚æœå½“æ•°æ®åº“ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè€Œç¼“å­˜å´æ²¡æœ‰åŒæ­¥ï¼Œæ­¤æ—¶å°±å‡ºç°äº†ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯¼è‡´ç”¨æˆ·ä»ç¼“å­˜ä¸­æ‹¿åˆ°çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ã€‚





#### ç¼“å­˜æ›´æ–°ç­–ç•¥é€‰æ‹©

- Cache Aside Pattern äººå·¥ç¼–ç æ–¹å¼ï¼šç¼“å­˜è°ƒç”¨è€…åœ¨æ›´æ–°å®Œæ•°æ®åº“åå†å»æ›´æ–°ç¼“å­˜ï¼Œä¹Ÿç§°ä¹‹ä¸º**åŒå†™æ–¹æ¡ˆ**
- Read/Write Through Pattern : ç”±ç³»ç»Ÿæœ¬èº«å®Œæˆï¼Œæ•°æ®åº“ä¸ç¼“å­˜çš„é—®é¢˜äº¤ç”±ç³»ç»Ÿæœ¬èº«å»å¤„ç†
- Write Behind Caching Pattern ï¼šè°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹å»å¼‚æ­¥å¤„ç†æ•°æ®åº“ï¼Œå®ç°æœ€ç»ˆä¸€è‡´



> **ç”±ç¼“å­˜çš„è°ƒç”¨è€…ï¼Œåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶åˆ é™¤ç¼“å­˜**  
>
> - æ³¨æ„è¿™é‡Œæ¶‰åŠåˆ°äº‹åŠ¡ï¼Œæ•°æ®åº“çš„æ›´æ–°å’Œç¼“å­˜çš„åˆ é™¤éœ€è¦ä¸€è‡´æ€§æ“ä½œï¼Œæ•°æ®åº“æ²¡æœ‰æ›´æ–°æˆåŠŸï¼Œåˆ™ä¸ä¼šåˆ é™¤ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰åˆ é™¤ï¼Œåˆ™ä¸ä¼šæ›´æ–°æ•°æ®åº“

æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼š

1. åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ
   - æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½è¦æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤šã€‚âŒ
   - åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ã€‚âœ”ï¸
2. å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ
   - å•ä½“ç³»ç»Ÿï¼šå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡
   - åˆ†å¸ƒå¼ç³»ç»Ÿï¼šåˆ©ç”¨ TCC ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ
3. å…ˆåˆ é™¤ç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ
   - å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“ï¼šâŒ
   - å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼šâœ”ï¸

**è¯»æ“ä½œï¼š**

- ç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼›
- ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾å®šè¶…æ—¶æ—¶é—´ã€‚

**å†™æ“ä½œï¼š**

- å…ˆå†™æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ï¼›ï¼ˆå®‰å…¨æ€§é—®é¢˜æ›´ä½ï¼‰
- è¦ç¡®ä¿æ•°æ®åº“ä¸ç¼“å­˜æ“ä½œçš„åŸå­æ€§ã€‚



### ç¼“å­˜ç©¿é€

**ç¼“å­˜ç©¿é€ï¼š**æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œç¼“å­˜æ°¸ä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚ä¸€ç›´ç›´æ¥è¯·æ±‚æ•°æ®åº“ã€‚ï¼ˆ**æ²¡æœ‰æŠ¤ç”²ï¼Œå³æ²¡æœ‰æ•°æ®**ï¼‰

ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å‹åŠ›ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

- ç¼“å­˜ç©ºå¯¹è±¡
  - ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿
  - ç¼ºç‚¹ï¼š
    - é¢å¤–çš„å†…å­˜æ¶ˆè€—
    - å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´
- å¸ƒéš†è¿‡æ»¤ï¼šå®¢æˆ·ç«¯å’Œ Redis ä¹‹é—´åŠ å…¥ä¸€å±‚å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆbitæ•°ç»„ï¼‰
  - ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼ŒRedis ä¸­æ²¡æœ‰å¤šä½™çš„ key
  - ç¼ºç‚¹ï¼š
    - å®ç°å¤æ‚
    - å­˜åœ¨è¯¯åˆ¤å¯èƒ½ï¼ˆå¸ƒéš†è¿‡æ»¤ä¸­ä¸å­˜åœ¨æ—¶æ•°æ®åº“ä¸­ä¸€å®šä¸å­˜åœ¨ï¼Œè¿‡æ»¤å™¨ä¸­å­˜åœ¨æ—¶æ•°æ®åº“ä¸­ä¸ä¸€å®šå­˜åœ¨ï¼‰
- å¢å¼º id çš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹ id è§„å¾‹
- åšå¥½æ•°æ®çš„åŸºç¡€è§„æ ¼æ ¡éªŒ
- åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ
- åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ



**å¸ƒéš†è¿‡æ»¤ï¼š**å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œ

å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›

è¿™ç§æ–¹å¼ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çªã€‚

![ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240725194039878.png)



### ç¼“å­˜é›ªå´©

**ç¼“å­˜é›ªå´©ï¼š**æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜ key åŒæ—¶å¤±æ•ˆæˆ–è€… Redis æœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚ï¼ˆå­˜åœ¨çš„å´©äº†ï¼Œå¯¼è‡´äº†ä¸¥é‡çš„ç¾éš¾ï¼‰

è§£å†³æ–¹æ¡ˆï¼š

* ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼
* åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§
* ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥
* ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜

![ç¼“å­˜é›ªå´©](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240725194348592.png)



### ç¼“å­˜å‡»ç©¿

**ç¼“å­˜å‡»ç©¿ï¼š**ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„ key çªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚ï¼ˆä¸€ä¸ªé”®[ç®­ ğŸ¹ ] å‡»ç©¿äº†ï¼‰

![ç¼“å­˜å‡»ç©¿](https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240725194955316.png)

å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š

* äº’æ–¥é”ï¼ˆæŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œå³ä¿è¯åªæœ‰ä¸€ä¸ªè¯·æ±‚è®¿é—®æ•°æ®åº“ï¼Œå…¶ä»–è¯·æ±‚ï¼ˆä¼‘çœ ï¼‰ç­‰å¾…è¿™ä¸ªè¯·æ±‚æ‹¿åˆ°çš„æ•°æ®æ”¾å…¥ç¼“å­˜å¹¶å¤±å»é”ä¹‹åæ‰èƒ½æ‹¿åˆ°æ•°æ®ï¼Œè¿™æ—¶è®¿é—®çš„æ˜¯ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ï¼‰

  > äº’æ–¥é”çš„å®ç°æ˜¯é€šè¿‡ redis çš„ setnx åŸç†ã€‚

* é€»è¾‘è¿‡æœŸï¼ˆä¸ç»™ key ç›´æ¥åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œç›´æ¥åœ¨ value ä¸­åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ‹¿åˆ°ä¹‹ååˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸï¼Œé‚£ä¹ˆå°±å¼€å¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”å»é‡æ„æ•°æ®ã€‚ï¼‰



<img src="https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240725195135561.png" alt="äº’æ–¥é”è§£å†³æ€è·¯" style="zoom:60%;display:block; float:left" />
<img src="https://web-tlias-mmh.oss-cn-beijing.aliyuncs.com/img/image-20240725195301733.png" alt="é€»è¾‘è¿‡æœŸæ€è·¯" style="zoom:50%;display:block; float:right" />

<br/><br/>
<br/><br/>
<br/>
<br/>
<br/>
<br/>


#### äº’æ–¥é”çš„å®ç°

æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨ redis çš„ setnx æ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯ redis ä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å› 1ï¼Œåœ¨ stringRedisTemplate ä¸­è¿”å› trueï¼Œ  å¦‚æœæœ‰è¿™ä¸ª key åˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨ stringRedisTemplate è¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ trueï¼Œæˆ–è€…æ˜¯ falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥ keyï¼ŒæˆåŠŸæ’å…¥çš„ key çš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹ã€‚

1. äº’æ–¥é”å·¥å…·å°è£…

```java
public class LockUtil{
    public static boolean tryLock(String key) {
        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, "1", 10, TimeUnit.SECONDS);
        return BooleanUtil.isTrue(flag);
    }

    public static void unlock(String key) {
        stringRedisTemplate.delete(key);
    }
}
```

2. ä½¿ç”¨äº’æ–¥é”æ“ä½œä»£ç æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯

- å…ˆä»ç¼“å­˜ä¸­è·å–æ•°æ®

  - æœ‰ï¼Œç›´æ¥è¿”å›å¯¹åº”çš„æ•°æ®

    > æ³¨æ„ï¼š
    >
    > - **" "** ç›´æ¥è¿”å› nullï¼Œå› ä¸ºè¿™é‡Œç¼“å­˜çš„æ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œä»£è¡¨æ•°æ®åº“ä¸­æ²¡æœ‰å¯¹åº”çš„æ•°æ® 

  - æ— ï¼ŒåŠ é”

    - åŠ é”æˆåŠŸï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼ŒåŠ å…¥ç¼“å­˜

      > æ³¨æ„ï¼š
      >
      > - æŸ¥è¯¢ç»“æœä¸º null æ—¶ï¼Œç¼“å­˜ "" ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯ null

    - åŠ é”å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œä¹‹åé‡æ–°è°ƒç”¨å½“å‰æ–¹æ³•è·å–æ•°æ®ã€‚

```java
 public User queryWithMutex(Long id)  {
        String key = CACHE_KEY + id;
        // 1ã€ä»redisä¸­æŸ¥è¯¢ç¼“å­˜
        String userJson = stringRedisTemplate.opsForValue().get("key");
        // 2ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (StrUtil.isNotBlank(userJson)) {
            // å­˜åœ¨,ç›´æ¥è¿”å›
            return JSONUtil.toBean(userJson, User.class);
        }
        //åˆ¤æ–­å‘½ä¸­çš„å€¼æ˜¯å¦æ˜¯ç©ºå€¼
        if (userJson != null) {
            //è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯
            return null;
        }
        // 4.å®ç°ç¼“å­˜é‡æ„
        //4.1 è·å–äº’æ–¥é”
        String lockKey = "lock:user:" + id;
        User user = null;
        try {
            boolean isLock = tryLock(lockKey);
            // 4.2 åˆ¤æ–­å¦è·å–æˆåŠŸ
            if(!isLock){
                //4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ é‡è¯•
                Thread.sleep(50);
                // é‡æ–°è°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–æ•°æ®
                return queryWithMutex(id);
            }
            //4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“
             user = getById(id);
            // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯
            if(user == null){
                 //å°†ç©ºå€¼å†™å…¥redis
                stringRedisTemplate.opsForValue().set(key,"",CACHE_NULL_TTL,TimeUnit.MINUTES);
                //è¿”å›é”™è¯¯ä¿¡æ¯
                return null;
            }
            //6.å†™å…¥redis
            stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(user),CACHE_NULL_TTL,TimeUnit.MINUTES);

        }catch (Exception e){
            throw new RuntimeException(e);
        }
        finally {
            //7.é‡Šæ”¾äº’æ–¥é”
            unlock(lockKey);
        }
        return user;
    }
```



#### é€»è¾‘è¿‡æœŸå®ç°

æ€è·¯åˆ†æï¼šåœ¨æœ‰**ç¼“å­˜é¢„çƒ­**çš„å‰æä¸‹ï¼Œå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢ redis æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°† value å–å‡ºï¼Œåˆ¤æ–­ value ä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚

1. æ„å»ºé€»è¾‘è¿‡æœŸçš„å¯¹è±¡çš„å®ä½“ç±»

```java
@Data
public class RedisData { Â   
    private LocalDateTime expireTime;
    private Object data;
}
```

2. æŸ¥è¯¢æ•°æ®

```java
public class UserService {
    @Resource
    private StringRedisTemplate stringRedisTemplate; 
    private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);
    public User queryWithLogicalExpire( Long id ){
        String key = CACHE_USER_KEY + id;
        // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜
        String json = stringRedisTemplate.opsForValue().get(key);
        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (StrUtil.isBlank(json)) {
            // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            return null;
        }
        // 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡
        RedisData redisData = JSONUtil.toBean(json, RedisData.class);
        User user = JSONUtil.toBean((JSONObject) redisData.getData(), User.class);
        LocalDateTime expireTime = redisData.getExpireTime();
        // 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
        if(expireTime.isAfter(LocalDateTime.now())) {
            // 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›ç”¨æˆ·ä¿¡æ¯
            return user;
        }
        // 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º
        // 6.ç¼“å­˜é‡å»º
        // 6.1.è·å–äº’æ–¥é”
        String lockKey = LOCK_User_KEY + id;
        boolean isLock = tryLock(lockKey);
        // 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
        if (isLock){
            CACHE_REBUILD_EXECUTOR.submit( ()->{

                try{
                    // æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ•°æ®å¹¶æ”¾å…¥ç¼“å­˜æ“ä½œ
                    this.saveUserToRedis(id,USER_EXPIRE_TIME);
                }catch (Exception e){
                    throw new RuntimeException(e);
                }finally {
                    unlock(lockKey);
                }
            });
        }
        // 6.4.è¿”å›è¿‡æœŸçš„ç”¨æˆ·ä¿¡æ¯
        return user;
    }
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶ä¿å­˜åˆ° Redis ä¸­
    public void saveUserToRedis(id, expireSeconds){
        // æŸ¥è¯¢æ•°æ®åº“
        User user = this.getById(id);
        RedisData redisData  = new RedisData();
        // è®¾ç½®æ•°æ®
        redisData.setData(user);
        // è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´
        redisData.setExpireTime(LocalDataTime.now().plusSeconds(expireSeconds));
        // æ”¾å…¥ç¼“å­˜
        stringRedisTemplate.opsForValue.set(CACHE_KEY+id,JSONUtil.toJsonStr(redisData));
    }
}
```





























