---
title: 使用网关实现鉴权
date: 2024-05-27
updated: 2024-05-27
tags: 
  - 实战
category: SpringCloud
comments: true
cover: https://tse2-mm.cn.bing.net/th/id/OIP-C.WS81HpzJpyOwdEy8Tw1RHgAAAA?w=302&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7
---

# 使用网关实现鉴权



### 1. 引入依赖

创建一个新的 module （mahua-gateway）并引入如下依赖，用于发现注册在 Nacos 中的用户鉴权服务

```XML
<!--网关-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacos discovery-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!--负载均衡-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```



### 2. 编写启动类

```java
@SpringBootApplication
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}
```



### 3. 配置路由

```YAML
server:
  port: 8080
spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: 192.168.150.101:8848
    gateway:
      routes:
        - id: provider # 路由规则id，自定义，唯一
          uri: lb://provider-service # 路由的目标服务，lb代表负载均衡，会从注册中心拉取服务列表
          predicates: # 路由断言，判断当前请求是否符合当前规则，符合则路由到目标服务
            - Path=/user/**,/search/** # 这里是以请求路径作为判断规则
        - id: caller
          uri: lb://caller-service
          predicates:
            - Path=/caller/**
```



### 4. 编写请求过滤器

```java
@Component
@RequiredArgsConstructor
@EnableConfigurationProperties(AuthProperties.class)
public class AuthGlobalFilter implements GlobalFilter, Ordered {

    // jwt 工具类
    private final JwtTool jwtTool;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1.获取Request
        ServerHttpRequest request = exchange.getRequest();
        // 2.判断是否不需要拦截
        if(/**判断请求路径是否需要拦截**/){
            // 无需拦截，直接放行
            return chain.filter(exchange);
        }
        // 3.获取请求头中的token
        String token = null;
        List<String> headers = request.getHeaders().get("authorization");
        if (!CollUtils.isEmpty(headers)) {
            token = headers.get(0);
        }
        // 4.校验并解析token
        Long userId = null;
        try {
            userId = jwtTool.parseToken(token);
        } catch (UnauthorizedException e) {
            // 如果无效，拦截
            ServerHttpResponse response = exchange.getResponse();
            response.setRawStatusCode(401);
            return response.setComplete();
        }

        // 5.如果有效，传递用户信息
        String userInfo = userId.toString();
        ServerWebExchange ex = exchange.mutate()
            .request(b -> b.header("user-info",userInfo))
            .builder();
        // 6.放行
        return chain.filter(ex);
    }
    @Override
    public int getOrder() {
        return 0;
    }
}
```



自此， **SpringCloud GateWay** 实现了用户鉴权，在其他服务中可以通过请求头 `user-info` 拿到 `userId`。